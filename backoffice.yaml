---
- name: backoffice
  hosts: backoffice
  remote_user: ubuntu
  become: true
  vars:
    app_user: ubuntu
    uwsgi_apps:
      - api-production
      - api-testing
      - husky-musher

  tasks:
    - import_tasks: tasks/apt-update.yaml
    - import_tasks: tasks/python.yaml
    - import_tasks: tasks/source.yaml
    - import_tasks: tasks/systemd.yaml
    - import_tasks: tasks/prometheus.yaml
    - import_tasks: tasks/uwsgi.yaml
    - import_tasks: tasks/switchboard.yaml
    - import_tasks: tasks/promtail.yaml

  handlers:
    - name: systemd units are re-read from disk
      systemd:
        daemon_reload: yes

    - name: prometheus is restarted
      service:
        name: prometheus
        state: restarted

    - name: prometheus is reloaded
      service:
        name: prometheus
        state: reloaded

    - name: uwsgi apps are restarted
      loop: "{{ uwsgi_apps }}"
      service:
        name: "uwsgi@{{ item }}"
        state: restarted

    - name: uwsgi apps are reloaded
      loop: "{{ uwsgi_apps }}"
      service:
        name: "uwsgi@{{ item }}"
        state: reloaded

    - name: promtail is restarted
      service:
        name: promtail
        state: restarted
