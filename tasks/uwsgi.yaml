---
- name: uwsgi is installed
  apt:
    package:
      - uwsgi
      - uwsgi-plugin-python3

- name: default uwsgi multi-app service is disabled
  service:
    name: uwsgi
    enabled: no
    state: stopped

- name: uwsgi base config exists
  copy:
    src: files/etc/uwsgi/base.ini
    dest: /etc/uwsgi/base.ini
    owner: root
    group: root
    mode: ugo=r
  notify:
    - uwsgi apps are reloaded

- name: uwsgi app configs exists
  loop: "{{ uwsgi_apps }}"
  copy:
    src: "files/etc/uwsgi/apps-available/{{ item }}.ini"
    dest: /etc/uwsgi/apps-available/
    owner: root
    group: root
    mode: ugo=r
  notify:
    - uwsgi apps are reloaded

- name: uwsgi app logs readable by adm group
  file:
    path: /var/log/uwsgi/app/
    state: directory
    owner: root
    group: adm
    mode: u=rwX,g=rX,o=
    recurse: yes

- name: uwsgi app logs default to adm group
  file:
    path: /var/log/uwsgi/app/
    state: directory
    owner: root
    group: adm
    mode: u=rwx,go=rxs

- name: uwsgi apps are enabled
  loop: "{{uwsgi_apps}}"
  service:
    name: "uwsgi@{{item}}"
    enabled: yes
    state: started

- name: uwsgi apps are enabled
  loop: "{{uwsgi_apps}}"
  service:
    name: "uwsgi@{{item}}"
    enabled: yes
    state: started

- name: uwsgi prometheus exporters are enabled
  loop: "{{uwsgi_apps}}"
  service:
    name: "prometheus-uwsgi-exporter@{{item}}"
    enabled: yes
    state: started
