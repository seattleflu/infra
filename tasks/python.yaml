---
- name: existing python path is registered (if exists)
  stat:
    path: /opt/python/{{python_version}}
  register: python_path

- name: Try to use a Python {{python_version}} binary tarball
  block:

  - name: python initial configuration is complete
    set_fact:
      python_bintar_ok: False

  - name: a python binary tarball exists
    when: development
    stat:
      path: /home/ubuntu/python-{{python_version}}-{{ansible_lsb.codename}}.tar.xz
      checksum_algorithm: sha256
    register: python_bintar_available

  - name: the python binary checksum is registered
    when: development and python_bintar_available.stat.exists
    shell:
      cmd: sha256sum -c /home/ubuntu/python-{{python_version}}-{{ansible_lsb.codename}}.tar.xz.sha256sum
    register: python_bintar_checksum

  - name: the python binary checksum is ok
    when: python_bintar_checksum.rc is defined and python_bintar_checksum.rc == 0
    set_fact:
      python_bintar_ok: True

  - name: the python installation directory is created
    file:
      path: /opt/python
      state: directory

  - name: python is installed from the binary tarball
    when: development and python_bintar_ok and not python_path.stat.exists
    unarchive:
      remote_src: yes
      src: /home/ubuntu/python-{{python_version}}-{{ansible_lsb.codename}}.tar.xz
      dest: /opt/python

  rescue:
  - name: Python binary installation failed, building from source
    set_fact:
      python_bintar_ok: False


- name: python build dependencies are installed
  apt:
    package:
      - build-essential
      - libbz2-dev
      - libffi-dev
      - libfontconfig1-dev
      - libfreetype6-dev
      - libgdbm-compat-dev
      - libgdbm-dev
      - libice-dev
      - liblzma-dev
      - libncurses5-dev
      - libpng-dev
      - libpthread-stubs0-dev
      - libreadline-dev
      - libsm-dev
      - libsqlite0-dev
      - libsqlite3-dev
      - libssl-dev
      - libtinfo-dev
      - libx11-dev
      - libxau-dev
      - libxcb1-dev
      - libxdmcp-dev
      - libxext-dev
      - libxft-dev
      - libxrender-dev
      - libxss-dev
      - libxt-dev
      - lzma-dev
      - tcl-dev
      - tcl8.6-dev
      - tk-dev
      - tk8.6-dev
      - uuid-dev
      - x11proto-core-dev
      - x11proto-dev
      - x11proto-scrnsaver-dev
      - x11proto-xext-dev
      - xtrans-dev
      - zlib1g-dev

- name: additional dependencies for Ubuntu Bionic are installed
  when: ansible_lsb.codename == 'bionic'
  apt:
    update-cache: yes
    package:
      - gcc-8
      - cpp-8
      - g++-8

- name: python source tarball is downloaded
  when: not python_path.stat.exists and not python_bintar_ok
  get_url:
    url: https://www.python.org/ftp/python/{{python_version}}/Python-{{python_version}}.tar.xz
    dest: /tmp

- name: untar python source tarball is completed
  when: not python_path.stat.exists and not python_bintar_ok
  unarchive:
    src: /tmp/Python-{{python_version}}.tar.xz
    dest: /tmp
    remote_src: yes

- name: python source is configured
  when: not ansible_lsb.codename == 'bionic' and not python_path.stat.exists and not python_bintar_ok
  command:
    cmd: ./configure --prefix=/opt/python/{{python_version}} --enable-optimizations
    chdir: /tmp/Python-{{python_version}}

- name: python source under Ubuntu 18.04 is configured
  when: ansible_lsb.codename == 'bionic' and not python_path.stat.exists and not python_bintar_ok
  shell:
    cmd: CC=/usr/bin/gcc-8 CXX=/usr/bin/g++-8 CPP=/usr/bin/cpp-8 ./configure --prefix=/opt/python/{{python_version}} --enable-optimizations
    chdir: /tmp/Python-{{python_version}}

- name: python was built from source (takes a while)
  when: not python_path.stat.exists and not python_bintar_ok
  command:
    cmd: make -j{{ansible_processor_vcpus}}
    chdir: /tmp/Python-{{python_version}}

- name: python was installed from source
  when: not python_path.stat.exists and not python_bintar_ok
  command:
    cmd: make install
    chdir: /tmp/Python-{{python_version}}
  register: python_source_installed

- name: python binary tarball was created
  when: development and not python_source_installed.skipped is defined
  archive:
    path: /opt/python/{{python_version}}
    dest: /home/ubuntu/python-{{python_version}}-{{ansible_lsb.codename}}.tar.xz
    format: xz

- name: checksum of python binary tarball is stored
  when: development and not python_source_installed.skipped is defined
  shell:
    cmd: sha256sum /home/ubuntu/python-{{python_version}}-{{ansible_lsb.codename}}.tar.xz > /home/ubuntu/python-{{python_version}}-{{ansible_lsb.codename}}.tar.xz.sha256sum

- name: essential python packages were installed
  pip:
    executable: /opt/python/{{python_version}}/bin/pip3
    name:
      - setuptools
      - wheel
      - pipenv

- name: python symlink is setup
  file:
    src: /opt/python/{{python_version}}
    dest: /opt/python/current
    state: link

- name: python was prepended to the system PATH
  lineinfile:
    path: /etc/environment
    backrefs: yes
    regexp: ^(PATH=")(/usr.*)
    line: '\g<1>/opt/python/current/bin:\g<2>'

- name: env variable for ensuring pipenv creates venvs within project was created
  lineinfile:
    path: /etc/environment
    regexp: '^PIPENV_VENV_IN_PROJECT=1$'
    line: 'PIPENV_VENV_IN_PROJECT=1'

- name: custom python path was registered
  stat:
    path: /opt/python/current/bin
  register: custom_python_path
